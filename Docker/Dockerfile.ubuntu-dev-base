FROM mcr.microsoft.com/devcontainers/base:ubuntu22.04

RUN <<EOF
apt-get update
apt-get upgrade
apt-get install -y software-properties-common
apt-get update
apt-get install -y jq unzip tmux bash-completion zsh
# for more recent version of neovim
wget https://github.com/neovim/neovim/releases/download/v0.9.5/nvim-linux64.tar.gz -O /usr/bin/nvim-linux64.tar.gz
cd /usr/bin/
tar xzvf nvim-linux64.tar.gz
ln -s /usr/bin/nvim-linux64/bin/nvim /usr/bin/nvim
mkdir /DEV
chsh -s /bin/zsh root
chsh -s /bin/zsh vscode
EOF


USER vscode
WORKDIR /home/vscode
RUN curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
RUN [ -d .config ] || mkdir .config \ 
    && git clone --depth=1 --filter=blob:none https://github.com/tmux-plugins/tpm /home/vscode/.tmux/plugins/tpm

RUN wget https://starship.rs/install.sh -O /tmp/starship-install.sh && /usr/bin/sh /tmp/starship-install.sh --yes

COPY ../confs/.tmux.conf /home/vscode/.tmux.conf
RUN /usr/bin/bash -c /home/vscode/.tmux/plugins/tpm/bin/install_plugins

# nvim lua setup
RUN [ -d .config ] || mkdir .config
WORKDIR /home/vscode/.config
RUN <<EOF
git init -b main
git config --local core.sparseCheckout true
git remote add -f origin https://github.com/igorovic/wsl-init.git
echo "nvim" >> .git/info/sparse-checkout
git pull origin main
EOF


WORKDIR /home/vscode
COPY ../confs/.zprofile /home/vscode/.zprofile
# # !!! `\n\` is important
RUN echo 'if [ -f $HOME/.zprofile ]; then\n\
    . $HOME/.zprofile\n\
fi\n\
if [ -z "$TMUX" ]\n\
then\n\
    tmux attach -t TMUX || tmux new -s TMUX\n\
fi' >> /home/vscode/.zshrc

RUN mkdir -p -m 0700 ~/.ssh && ssh-keyscan gitlab.com >> ~/.ssh/known_hosts

CMD [ "/bin/zsh" ]